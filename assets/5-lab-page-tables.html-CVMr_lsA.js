import{_ as t}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as p,o as c,c as o,a as n,d as a,b as l,e as s}from"./app-BwT2IjHU.js";const i="/assets/image-20240509111735902-MYzY1ScM.png",u={},r=s(`<h1 id="lab-page-tables" tabindex="-1"><a class="header-anchor" href="#lab-page-tables"><span>Lab: page tables</span></a></h1><p>在这个实验中，你将探索页面表并修改它们以加速特定的系统调用，并检测哪些页面已被访问。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>在你开始编码之前，请阅读 xv6 书的第三章以及相关文件：</p><ul><li>kernel/memlayout.h，其中包含内存布局的信息。</li><li>kernel/vm.c，其中包含大部分虚拟内存（VM）代码。</li><li>kernel/kalloc.c，其中包含分配和释放物理内存的代码。 同时，参考 RISC-V 特权架构手册可能也会有所帮助。</li></ul></div><p>要开始实验，请切换到 pgtbl 分支：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>$ <span class="token function">git</span> fetch 
$ <span class="token function">git</span> checkout pgtbl 
$ <span class="token function">make</span> clean
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5),d={id:"speed-up-system-calls-easy",tabindex:"-1"},k={class:"header-anchor",href:"#speed-up-system-calls-easy"},m={href:"https://pdos.csail.mit.edu/6.S081/2023/labs/guidance.html",target:"_blank",rel:"noopener noreferrer"},b=s('<h3 id="实验要求翻译" tabindex="-1"><a class="header-anchor" href="#实验要求翻译"><span>实验要求翻译</span></a></h3><p>一些操作系统（例如Linux）通过在用户空间和内核之间共享一块只读空间来加速某些特定的系统调用。这消除了执行这些系统调用时需要内核交叉的需求。为了帮助你学习如何将映射插入到页面表中，你的第一个任务是为 xv6 中的 getpid() 系统调用实现这种优化。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>在每个进程创建时，在 USYSCALL（在 memlayout.h 中定义的一个虚拟地址）处映射一个只读页面。在这个页面的开头，存储一个 struct usyscall（也在 memlayout.h 中定义），并将其初始化为存储当前进程的 PID。在这个实验中，ugetpid() 已经在用户空间中提供，并将自动使用 USYSCALL 映射。如果运行 pgtbltest 时 ugetpid 测试用例通过，则你将获得此实验的完整学分。</p></div><p>一些提示：</p><ul><li>你可以在 kernel/proc.c 中的 proc_pagetable() 中执行映射。</li><li>选择允许用户空间只读取页面的权限位。</li><li>你可能会发现 mappages() 是一个有用的实用程序。</li><li>不要忘记在 allocproc() 中分配和初始化页面。 确保在 freeproc() 中释放页面。</li></ul><div class="hint-container important"><p class="hint-container-title">重要</p><p>ChatGPT 你还可以使用共享页面加速哪些其他 xv6 系统调用？请解释一下。</p></div><h3 id="实验操作" tabindex="-1"><a class="header-anchor" href="#实验操作"><span>实验操作</span></a></h3><p>进行实操前需要回答几个问题：</p><ol><li>usyscall这个结构体需要存在哪里</li><li>需要建立虚拟地址与物理地址的映射，物理地址要怎么获取？</li><li>初始化与释放需要做什么？</li></ol><h4 id="step1" tabindex="-1"><a class="header-anchor" href="#step1"><span>step1</span></a></h4><p>在 <code>proc.h</code>中声明一个<code>usyscall</code>结构体，用于存放共享页面。</p><figure><img src="'+i+`" alt="image-20240509111735902" tabindex="0" loading="lazy"><figcaption>image-20240509111735902</figcaption></figure><h4 id="step2" tabindex="-1"><a class="header-anchor" href="#step2"><span>step2</span></a></h4><p>在(<code>kernel/proc.c</code>)中修改<code>allocproc</code>方法，仿照给<code>trapframe</code>为<code>p-&gt;usyscall</code> 分配具体的物理地址，并且将进程的pid 保存到这个结构体之中。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code>  <span class="token comment">// Allocate a usyscall page</span>
  <span class="token comment">//这里的地址其实就是一个物理地址，是需要在用户页表中与逻辑地址进行映射的的地址</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>usyscall <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usyscall</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  p<span class="token operator">-&gt;</span>usyscall<span class="token operator">-&gt;</span>pid <span class="token operator">=</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="step3" tabindex="-1"><a class="header-anchor" href="#step3"><span>step3</span></a></h4><p>在<code>(kernel/proc.c)</code>中修改<code>proc_pagetable</code>方法，仿照给<code>trapframe</code>新增映射关系，这里实验有要求许用户空间只读取页面的权限位，所以使用权限<code>PTE_R</code>与<code>PTE_U</code></p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span>USYSCALL<span class="token punctuation">,</span>PGSIZE<span class="token punctuation">,</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>usyscall<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_R <span class="token operator">|</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="step4" tabindex="-1"><a class="header-anchor" href="#step4"><span>step4</span></a></h4><p>在(<code>kernel/proc.c</code>)中修改<code>freeproc</code>与<code>proc_freepagetable</code>，在进程释放的时候将对应内存释放掉。</p><p><code>freeproc</code>中增加</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">freeproc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">//新增代码 begin</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>usyscall<span class="token punctuation">)</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>usyscall<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>usyscall <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//新增代码 end</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>trapframe<span class="token punctuation">)</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>trapframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>trapframe <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">)</span>
    <span class="token function">proc_freepagetable</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>proc_freepagetable</code>中增加</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">proc_freepagetable</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">//为什么这里不释放会导致panic: freewalk: leaf</span>
  <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//新增行</span>
  <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAMPOLINE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAPFRAME<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,24);function v(g,h){const e=p("ExternalLinkIcon");return c(),o("div",null,[r,n("h2",d,[n("a",k,[n("span",null,[a("Speed up system calls ("),n("a",m,[a("easy"),l(e)]),a(")")])])]),b])}const _=t(u,[["render",v],["__file","5-lab-page-tables.html.vue"]]),x=JSON.parse(`{"path":"/cs-basics/os/6.S081/labs/5-lab-page-tables.html","title":"Lab: page tables","lang":"zh-CN","frontmatter":{"icon":"code-bold","date":"2024-05-08T00:00:00.000Z","category":["操作系统"],"tag":["MIT","XV6","riscv","C"],"description":"Lab: page tables 在这个实验中，你将探索页面表并修改它们以加速特定的系统调用，并检测哪些页面已被访问。 注意 在你开始编码之前，请阅读 xv6 书的第三章以及相关文件： kernel/memlayout.h，其中包含内存布局的信息。 kernel/vm.c，其中包含大部分虚拟内存（VM）代码。 kernel/kalloc.c，其中包含分...","head":[["meta",{"property":"og:url","content":"https://passerbyjia.github.io/cs-basics/os/6.S081/labs/5-lab-page-tables.html"}],["meta",{"property":"og:site_name","content":"Plus's NoteBook"}],["meta",{"property":"og:title","content":"Lab: page tables"}],["meta",{"property":"og:description","content":"Lab: page tables 在这个实验中，你将探索页面表并修改它们以加速特定的系统调用，并检测哪些页面已被访问。 注意 在你开始编码之前，请阅读 xv6 书的第三章以及相关文件： kernel/memlayout.h，其中包含内存布局的信息。 kernel/vm.c，其中包含大部分虚拟内存（VM）代码。 kernel/kalloc.c，其中包含分..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-09T08:28:50.000Z"}],["meta",{"property":"article:author","content":"Plus"}],["meta",{"property":"article:tag","content":"MIT"}],["meta",{"property":"article:tag","content":"XV6"}],["meta",{"property":"article:tag","content":"riscv"}],["meta",{"property":"article:tag","content":"C"}],["meta",{"property":"article:published_time","content":"2024-05-08T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-05-09T08:28:50.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Lab: page tables\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-05-08T00:00:00.000Z\\",\\"dateModified\\":\\"2024-05-09T08:28:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Plus\\",\\"url\\":\\"https://passerbyjia.github.io\\"}]}"]]},"headers":[{"level":2,"title":"Speed up system calls (easy)","slug":"speed-up-system-calls-easy","link":"#speed-up-system-calls-easy","children":[{"level":3,"title":"实验要求翻译","slug":"实验要求翻译","link":"#实验要求翻译","children":[]},{"level":3,"title":"实验操作","slug":"实验操作","link":"#实验操作","children":[]}]}],"git":{"createdTime":1715185891000,"updatedTime":1715243330000,"contributors":[{"name":"JH","email":"jh_personal@163.com","commits":4}]},"readingTime":{"minutes":3.01,"words":902},"filePathRelative":"cs-basics/os/6.S081/labs/5-lab-page-tables.md","localizedDate":"2024年5月8日","excerpt":"\\n<p>在这个实验中，你将探索页面表并修改它们以加速特定的系统调用，并检测哪些页面已被访问。</p>\\n<div class=\\"hint-container warning\\">\\n<p class=\\"hint-container-title\\">注意</p>\\n<p>在你开始编码之前，请阅读 xv6 书的第三章以及相关文件：</p>\\n<ul>\\n<li>kernel/memlayout.h，其中包含内存布局的信息。</li>\\n<li>kernel/vm.c，其中包含大部分虚拟内存（VM）代码。</li>\\n<li>kernel/kalloc.c，其中包含分配和释放物理内存的代码。 同时，参考 RISC-V 特权架构手册可能也会有所帮助。</li>\\n</ul>\\n</div>","autoDesc":true}`);export{_ as comp,x as data};
